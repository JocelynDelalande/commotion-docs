\hypertarget{loop_8h}{\section{src/loop.h File Reference}
\label{loop_8h}\index{src/loop.\+h@{src/loop.\+h}}
}


a simple object-\/oriented event loop  


{\ttfamily \#include $<$stdlib.\+h$>$}\\*
{\ttfamily \#include \char`\"{}process.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}socket.\+h\char`\"{}}\\*
\subsection*{Classes}
\begin{DoxyCompactItemize}
\item 
struct \hyperlink{structco__timer__t}{co\+\_\+timer\+\_\+t}
\end{DoxyCompactItemize}
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\hypertarget{loop_8h_a5d47e0dcaba53c65ffc70e71870f3892}{\#define {\bfseries L\+O\+O\+P\+\_\+\+M\+A\+X\+P\+R\+O\+C}~20}\label{loop_8h_a5d47e0dcaba53c65ffc70e71870f3892}

\item 
\hypertarget{loop_8h_ac48f19ab97d410c7f568b51e451710c1}{\#define {\bfseries L\+O\+O\+P\+\_\+\+M\+A\+X\+S\+O\+C\+K}~20}\label{loop_8h_ac48f19ab97d410c7f568b51e451710c1}

\item 
\hypertarget{loop_8h_a66f74d29c1ce8d908aa57d52bd536986}{\#define {\bfseries L\+O\+O\+P\+\_\+\+M\+A\+X\+E\+V\+E\+N\+T}~64}\label{loop_8h_a66f74d29c1ce8d908aa57d52bd536986}

\item 
\hypertarget{loop_8h_acc972b3d184917824699e45719b5e83f}{\#define {\bfseries L\+O\+O\+P\+\_\+\+T\+I\+M\+E\+O\+U\+T}~5}\label{loop_8h_acc972b3d184917824699e45719b5e83f}

\item 
\hypertarget{loop_8h_a72a2d47f6674292221c71094e6f8314c}{\#define {\bfseries L\+O\+O\+P\+\_\+\+M\+A\+X\+T\+I\+M\+E\+R}~20}\label{loop_8h_a72a2d47f6674292221c71094e6f8314c}

\end{DoxyCompactItemize}
\subsection*{Typedefs}
\begin{DoxyCompactItemize}
\item 
\hypertarget{loop_8h_a1fb4bcefa2e4a60496f3ac4b6cb68ffc}{typedef struct \hyperlink{structco__timer__t}{co\+\_\+timer\+\_\+t} {\bfseries co\+\_\+timer\+\_\+t}}\label{loop_8h_a1fb4bcefa2e4a60496f3ac4b6cb68ffc}

\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hypertarget{loop_8h_a85bfdf2883afdf4b60e4013b693fdb0c}{struct \hyperlink{structco__timer__t}{co\+\_\+timer\+\_\+t} {\bfseries \+\_\+\+\_\+attribute\+\_\+\+\_\+} ((packed))}\label{loop_8h_a85bfdf2883afdf4b60e4013b693fdb0c}

\item 
\hypertarget{loop_8h_a6a94b092a316fa69d0a983f42a193216}{int \hyperlink{loop_8h_a6a94b092a316fa69d0a983f42a193216}{co\+\_\+loop\+\_\+create} (void)}\label{loop_8h_a6a94b092a316fa69d0a983f42a193216}

\begin{DoxyCompactList}\small\item\em sets up the event loop \end{DoxyCompactList}\item 
\hypertarget{loop_8h_a7922af05b99afadbc01dc5035ad87c5e}{int \hyperlink{loop_8h_a7922af05b99afadbc01dc5035ad87c5e}{co\+\_\+loop\+\_\+destroy} (void)}\label{loop_8h_a7922af05b99afadbc01dc5035ad87c5e}

\begin{DoxyCompactList}\small\item\em closes the event loop \end{DoxyCompactList}\item 
\hypertarget{loop_8h_a6837c86efdac9761665528835642c8b2}{void \hyperlink{loop_8h_a6837c86efdac9761665528835642c8b2}{co\+\_\+loop\+\_\+start} (void)}\label{loop_8h_a6837c86efdac9761665528835642c8b2}

\begin{DoxyCompactList}\small\item\em starts the event loop, listening for messages on sockets via \+\_\+co\+\_\+loop\+\_\+poll\+\_\+sockets \end{DoxyCompactList}\item 
\hypertarget{loop_8h_a468ea7b7e5aad7338be49a434ed53bc0}{void \hyperlink{loop_8h_a468ea7b7e5aad7338be49a434ed53bc0}{co\+\_\+loop\+\_\+stop} (void)}\label{loop_8h_a468ea7b7e5aad7338be49a434ed53bc0}

\begin{DoxyCompactList}\small\item\em stops the event loop \end{DoxyCompactList}\item 
int \hyperlink{loop_8h_aca2f623f8b78b933878c7432011c3f9a}{co\+\_\+loop\+\_\+add\+\_\+process} (\hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} $\ast$proc)
\begin{DoxyCompactList}\small\item\em adds a process to the event loop (for it to listen for) \end{DoxyCompactList}\item 
int \hyperlink{loop_8h_aeeb0953602d805cd06c9652dabb851b9}{co\+\_\+loop\+\_\+remove\+\_\+process} (pid\+\_\+t pid)
\begin{DoxyCompactList}\small\item\em removes a process from the event loop \end{DoxyCompactList}\item 
int \hyperlink{loop_8h_aecd6703f3b0738ef8dd9c31967dc48bf}{co\+\_\+loop\+\_\+add\+\_\+socket} (\hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} $\ast$new\+\_\+sock, \hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} $\ast$context)
\begin{DoxyCompactList}\small\item\em adds a new socket to the event loop (for it to listen on) \end{DoxyCompactList}\item 
int \hyperlink{loop_8h_a73e03ee56a79f6b03a33d4edfa14f646}{co\+\_\+loop\+\_\+remove\+\_\+socket} (\hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} $\ast$old\+\_\+sock, \hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} $\ast$context)
\begin{DoxyCompactList}\small\item\em removes a socket from the event loop \end{DoxyCompactList}\item 
\hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} $\ast$ \hyperlink{loop_8h_a8f85ea6b81607ddf7a74232137a28381}{co\+\_\+loop\+\_\+get\+\_\+socket} (char $\ast$uri, \hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} $\ast$context)
\begin{DoxyCompactList}\small\item\em gets a socket that is registered with the event loop \end{DoxyCompactList}\item 
int \hyperlink{loop_8h_a1aa3e1a56c2c4d841f4a5a481a5cbd57}{co\+\_\+loop\+\_\+add\+\_\+timer} (\hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} $\ast$new\+\_\+timer, \hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} $\ast$context)
\begin{DoxyCompactList}\small\item\em schedules a new timer with the event loop \end{DoxyCompactList}\item 
int \hyperlink{loop_8h_a15cca15cee610bb8222250aef0073b8e}{co\+\_\+loop\+\_\+remove\+\_\+timer} (\hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} $\ast$old\+\_\+timer, \hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} $\ast$context)
\begin{DoxyCompactList}\small\item\em removes a timer from the event loop \end{DoxyCompactList}\item 
int \hyperlink{loop_8h_a47313da5ab494c447679836e95b01a26}{co\+\_\+loop\+\_\+set\+\_\+timer} (\hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} $\ast$timer, long msecs, \hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} $\ast$context)
\begin{DoxyCompactList}\small\item\em sets timer to expire in msecs from now \end{DoxyCompactList}\item 
\hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} $\ast$ \hyperlink{loop_8h_aac6c95a37b381c1584dbd0e8776c69a3}{co\+\_\+loop\+\_\+get\+\_\+timer} (void $\ast$ptr, \hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} $\ast$context)
\begin{DoxyCompactList}\small\item\em gets a socket that is registered with the event loop \end{DoxyCompactList}\item 
\hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} $\ast$ \hyperlink{loop_8h_ad2df16784f2796d2415250cd0a2abd19}{co\+\_\+timer\+\_\+create} (struct timeval deadline, co\+\_\+cb\+\_\+t timer\+\_\+cb, void $\ast$ptr)
\begin{DoxyCompactList}\small\item\em malloc and initialize a timer \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hypertarget{loop_8h_aa20afbf3f0a782bb4dea4da22df275a3}{\hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} {\bfseries \+\_\+header}}\label{loop_8h_aa20afbf3f0a782bb4dea4da22df275a3}

\item 
\hypertarget{loop_8h_a05de11e79f277be86c869a1fc6a204bd}{uint8\+\_\+t {\bfseries \+\_\+exttype}}\label{loop_8h_a05de11e79f277be86c869a1fc6a204bd}

\item 
\hypertarget{loop_8h_a5ff8177a0b8e2c9f9c18bd0cb34e65f8}{uint8\+\_\+t {\bfseries \+\_\+len}}\label{loop_8h_a5ff8177a0b8e2c9f9c18bd0cb34e65f8}

\item 
\hypertarget{loop_8h_a39f16d585c4531d2bf2562631a775d73}{bool {\bfseries pending}}\label{loop_8h_a39f16d585c4531d2bf2562631a775d73}

\item 
\hypertarget{loop_8h_a4efb8d234a74f0eb2567f4623d9189ce}{struct timeval {\bfseries deadline}}\label{loop_8h_a4efb8d234a74f0eb2567f4623d9189ce}

\item 
\hypertarget{loop_8h_a7a4c1ec37e131a87d872afe50927aa97}{co\+\_\+cb\+\_\+t {\bfseries timer\+\_\+cb}}\label{loop_8h_a7a4c1ec37e131a87d872afe50927aa97}

\item 
\hypertarget{loop_8h_add9af9569af79ec26dd741fb226b38ba}{void $\ast$ {\bfseries ptr}}\label{loop_8h_add9af9569af79ec26dd741fb226b38ba}

\end{DoxyCompactItemize}


\subsection{Detailed Description}
a simple object-\/oriented event loop 

\begin{DoxyAuthor}{Author}
Josh King (jheretic), \href{mailto:jking@chambana.net}{\tt jking@chambana.\+net} 
\end{DoxyAuthor}


\subsection{Function Documentation}
\hypertarget{loop_8h_aca2f623f8b78b933878c7432011c3f9a}{\index{loop.\+h@{loop.\+h}!co\+\_\+loop\+\_\+add\+\_\+process@{co\+\_\+loop\+\_\+add\+\_\+process}}
\index{co\+\_\+loop\+\_\+add\+\_\+process@{co\+\_\+loop\+\_\+add\+\_\+process}!loop.\+h@{loop.\+h}}
\subsubsection[{co\+\_\+loop\+\_\+add\+\_\+process}]{\setlength{\rightskip}{0pt plus 5cm}int co\+\_\+loop\+\_\+add\+\_\+process (
\begin{DoxyParamCaption}
\item[{{\bf co\+\_\+obj\+\_\+t} $\ast$}]{proc}
\end{DoxyParamCaption}
)}}\label{loop_8h_aca2f623f8b78b933878c7432011c3f9a}


adds a process to the event loop (for it to listen for) 


\begin{DoxyParams}{Parameters}
{\em proc} & the process to be added \\
\hline
\end{DoxyParams}


References co\+\_\+list\+\_\+append().


\begin{DoxyCode}
310                                         \{
311   CHECK(IS\_PROCESS(proc),\textcolor{stringliteral}{"Not a process."});
312   CHECK(\hyperlink{list_8c_ada7536773e05cf3dcb33ab73ac2ef84e}{co\_list\_append}(processes,proc),\textcolor{stringliteral}{"Failed to add process %d"},((
      \hyperlink{structco__process__t}{co\_process\_t}*)proc)->pid);
313   ((\hyperlink{structco__process__t}{co\_process\_t}*)proc)->registered = \textcolor{keyword}{true}; 
314   \textcolor{keywordflow}{return} 1;
315 error:
316   \textcolor{keywordflow}{return} 0;
317 \}
\end{DoxyCode}
\hypertarget{loop_8h_aecd6703f3b0738ef8dd9c31967dc48bf}{\index{loop.\+h@{loop.\+h}!co\+\_\+loop\+\_\+add\+\_\+socket@{co\+\_\+loop\+\_\+add\+\_\+socket}}
\index{co\+\_\+loop\+\_\+add\+\_\+socket@{co\+\_\+loop\+\_\+add\+\_\+socket}!loop.\+h@{loop.\+h}}
\subsubsection[{co\+\_\+loop\+\_\+add\+\_\+socket}]{\setlength{\rightskip}{0pt plus 5cm}int co\+\_\+loop\+\_\+add\+\_\+socket (
\begin{DoxyParamCaption}
\item[{{\bf co\+\_\+obj\+\_\+t} $\ast$}]{new\+\_\+sock, }
\item[{{\bf co\+\_\+obj\+\_\+t} $\ast$}]{context}
\end{DoxyParamCaption}
)}}\label{loop_8h_aecd6703f3b0738ef8dd9c31967dc48bf}


adds a new socket to the event loop (for it to listen on) 


\begin{DoxyParams}{Parameters}
{\em new\+\_\+sock} & the new socket to be added \\
\hline
{\em context} & a \hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} context pointer (currently unused) \\
\hline
\end{DoxyParams}


References co\+\_\+list\+\_\+append(), co\+\_\+list\+\_\+contains(), co\+\_\+list\+\_\+parse(), and co\+\_\+loop\+\_\+remove\+\_\+socket().



Referenced by \+\_\+watch(), and main().


\begin{DoxyCode}
330                                                               \{
331   DEBUG(\textcolor{stringliteral}{"Adding socket to event loop."});
332   CHECK(IS\_SOCK(new\_sock),\textcolor{stringliteral}{"Not a socket."});
333   \hyperlink{structco__socket__t}{co\_socket\_t} *sock = (\hyperlink{structco__socket__t}{co\_socket\_t}*)new\_sock;
334   \hyperlink{structco__fd__t}{co\_fd\_t} *fd = (\hyperlink{structco__fd__t}{co\_fd\_t}*)context;
335   CHECK(fd->socket == sock,\textcolor{stringliteral}{"FD does not match socket"});
336   \hyperlink{structco__obj__t}{co\_obj\_t} *node = NULL;
337   \textcolor{keyword}{struct }epoll\_event event;
338 
339   memset(&event, 0, \textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} epoll\_event));
340   \textcolor{keyword}{event}.events = EPOLLIN;
341 
342   \textcolor{keywordflow}{if}((node = \hyperlink{list_8c_a53067bb4fab9f78bdc6e69381bbccd16}{co\_list\_parse}(sockets, \_co\_loop\_match\_socket\_i, sock->uri))) \{
343     CHECK((node == (\hyperlink{structco__obj__t}{co\_obj\_t}*)sock), \textcolor{stringliteral}{"Different socket with URI %s already registered."}, sock->uri)
      ;
344     \textcolor{keywordflow}{if} ((sock->listen) && (sock->fd->fd > 0) && sock->fd\_registered) \{
345       CHECK(\hyperlink{list_8c_a102c8920e3ec13c06747dc752efd91e7}{co\_list\_contains}(sock->rfd\_lst,(\hyperlink{structco__obj__t}{co\_obj\_t}*)fd),\textcolor{stringliteral}{"Socket does not contain
       FD"});
346       DEBUG(\textcolor{stringliteral}{"Adding RFD %d to epoll."}, fd->fd);
347       \textcolor{keyword}{event}.data.ptr = (\hyperlink{structco__obj__t}{co\_obj\_t}*)fd;
348       CHECK((epoll\_ctl(poll\_fd, EPOLL\_CTL\_ADD, fd->fd, &event)) != -1, \textcolor{stringliteral}{"Failed to add receive FD epoll
       event."});
349     \} \textcolor{keywordflow}{else} \{
350       SENTINEL(\textcolor{stringliteral}{"Socket %s already registered."}, sock->uri);
351     \}
352   \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}((sock->listen) && (sock->fd->fd > 0) && !sock->fd\_registered) \{
353       CHECK(fd = sock->fd,\textcolor{stringliteral}{"Invalid listening socket"});
354       DEBUG(\textcolor{stringliteral}{"Adding FD %d to epoll."}, sock->fd->fd);
355       \textcolor{keyword}{event}.data.ptr = (\hyperlink{structco__obj__t}{co\_obj\_t}*)fd;
356       CHECK((epoll\_ctl(poll\_fd, EPOLL\_CTL\_ADD, sock->fd->fd, &event)) != -1, \textcolor{stringliteral}{"Failed to add listen FD epoll
       event."});
357       sock->fd\_registered = \textcolor{keyword}{true}; 
358       \hyperlink{list_8c_ada7536773e05cf3dcb33ab73ac2ef84e}{co\_list\_append}(sockets, (\hyperlink{structco__obj__t}{co\_obj\_t}*)sock);
359       \textcolor{keywordflow}{return} 1;
360   \} \textcolor{keywordflow}{else} \{
361       \hyperlink{loop_8c_a73e03ee56a79f6b03a33d4edfa14f646}{co\_loop\_remove\_socket}((\hyperlink{structco__obj__t}{co\_obj\_t}*)sock, NULL);
362       SENTINEL(\textcolor{stringliteral}{"Unknown error registering socket %s."}, sock->uri);
363   \}
364 
365 error:
366   \textcolor{keywordflow}{return} 0;
367 \}
\end{DoxyCode}
\hypertarget{loop_8h_a1aa3e1a56c2c4d841f4a5a481a5cbd57}{\index{loop.\+h@{loop.\+h}!co\+\_\+loop\+\_\+add\+\_\+timer@{co\+\_\+loop\+\_\+add\+\_\+timer}}
\index{co\+\_\+loop\+\_\+add\+\_\+timer@{co\+\_\+loop\+\_\+add\+\_\+timer}!loop.\+h@{loop.\+h}}
\subsubsection[{co\+\_\+loop\+\_\+add\+\_\+timer}]{\setlength{\rightskip}{0pt plus 5cm}int co\+\_\+loop\+\_\+add\+\_\+timer (
\begin{DoxyParamCaption}
\item[{{\bf co\+\_\+obj\+\_\+t} $\ast$}]{new\+\_\+timer, }
\item[{{\bf co\+\_\+obj\+\_\+t} $\ast$}]{context}
\end{DoxyParamCaption}
)}}\label{loop_8h_a1aa3e1a56c2c4d841f4a5a481a5cbd57}


schedules a new timer with the event loop 


\begin{DoxyParams}{Parameters}
{\em timer} & the timer to schedule \\
\hline
{\em context} & a \hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} context pointer (currently unused) \\
\hline
\end{DoxyParams}


References co\+\_\+list\+\_\+append(), co\+\_\+list\+\_\+insert\+\_\+before(), and co\+\_\+list\+\_\+parse().



Referenced by \+\_\+schedule(), and co\+\_\+loop\+\_\+set\+\_\+timer().


\begin{DoxyCode}
397                                                               \{
398   \hyperlink{structco__timer__t}{co\_timer\_t} *timer = (\hyperlink{structco__timer__t}{co\_timer\_t}*)new\_timer;
399   \hyperlink{structco__obj__t}{co\_obj\_t} *node = NULL;
400   \textcolor{keyword}{struct }timeval now;
401   
402   \textcolor{keywordflow}{if} (timer->pending)
403     \textcolor{keywordflow}{return} 0;
404   
405   \_co\_loop\_gettime(&now);
406   CHECK(timer->timer\_cb,\textcolor{stringliteral}{"No callback function associated with timer"});
407   CHECK(\_co\_loop\_tv\_diff(&timer->deadline,&now) > -1000,\textcolor{stringliteral}{"Invalid timer deadline: %ld.%06ld  %ld.%06ld"},
408   timer->deadline.tv\_sec,timer->deadline.tv\_usec,
409   now.tv\_sec,now.tv\_usec);
410     
411   CHECK(\hyperlink{list_8c_a53067bb4fab9f78bdc6e69381bbccd16}{co\_list\_parse}(timers,\_co\_loop\_match\_timer\_i,timer->ptr) == NULL,\textcolor{stringliteral}{"Timer already
       scheduled"});
412   
413   \textcolor{comment}{// insert into list in chronological order}
414   \textcolor{keywordflow}{if}((node = \hyperlink{list_8c_a53067bb4fab9f78bdc6e69381bbccd16}{co\_list\_parse}(timers, \_co\_loop\_compare\_timer\_i, &timer->deadline))) \{
415     CHECK(\hyperlink{list_8c_a02a669e051437a627198ba279a71d329}{co\_list\_insert\_before}(timers,(\hyperlink{structco__obj__t}{co\_obj\_t}*)timer,node),\textcolor{stringliteral}{"Failed to
       insert timer."});
416   \} \textcolor{keywordflow}{else} \{
417     CHECK(\hyperlink{list_8c_ada7536773e05cf3dcb33ab73ac2ef84e}{co\_list\_append}(timers,(\hyperlink{structco__obj__t}{co\_obj\_t}*)timer),\textcolor{stringliteral}{"Failed to insert timer."});
418   \}
419   
420 \textcolor{comment}{//   DEBUG("Successfully added timer %ld.%06ld
       %p",timer->deadline.tv\_sec,timer->deadline.tv\_usec,timer->ptr);}
421   
422   timer->pending = \textcolor{keyword}{true};
423   \textcolor{keywordflow}{return} 1;
424   
425 error:
426   \textcolor{keywordflow}{return} 0;
427 \}
\end{DoxyCode}
\hypertarget{loop_8h_a8f85ea6b81607ddf7a74232137a28381}{\index{loop.\+h@{loop.\+h}!co\+\_\+loop\+\_\+get\+\_\+socket@{co\+\_\+loop\+\_\+get\+\_\+socket}}
\index{co\+\_\+loop\+\_\+get\+\_\+socket@{co\+\_\+loop\+\_\+get\+\_\+socket}!loop.\+h@{loop.\+h}}
\subsubsection[{co\+\_\+loop\+\_\+get\+\_\+socket}]{\setlength{\rightskip}{0pt plus 5cm}{\bf co\+\_\+obj\+\_\+t}$\ast$ co\+\_\+loop\+\_\+get\+\_\+socket (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{uri, }
\item[{{\bf co\+\_\+obj\+\_\+t} $\ast$}]{context}
\end{DoxyParamCaption}
)}}\label{loop_8h_a8f85ea6b81607ddf7a74232137a28381}


gets a socket that is registered with the event loop 


\begin{DoxyParams}{Parameters}
{\em uri} & a U\+R\+I to match against the available sockets \\
\hline
{\em context} & a \hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} context pointer (currently unused) \\
\hline
\end{DoxyParams}


References co\+\_\+list\+\_\+parse().


\begin{DoxyCode}
389                                                            \{
390   \hyperlink{structco__obj__t}{co\_obj\_t} *sock = NULL;
391   CHECK((sock = \hyperlink{list_8c_a53067bb4fab9f78bdc6e69381bbccd16}{co\_list\_parse}(sockets, \_co\_loop\_match\_socket\_i, uri)), \textcolor{stringliteral}{"Failed to find socket
       %s"}, uri);
392   \textcolor{keywordflow}{return} sock;
393 error:
394   \textcolor{keywordflow}{return} NULL;
395 \}
\end{DoxyCode}
\hypertarget{loop_8h_aac6c95a37b381c1584dbd0e8776c69a3}{\index{loop.\+h@{loop.\+h}!co\+\_\+loop\+\_\+get\+\_\+timer@{co\+\_\+loop\+\_\+get\+\_\+timer}}
\index{co\+\_\+loop\+\_\+get\+\_\+timer@{co\+\_\+loop\+\_\+get\+\_\+timer}!loop.\+h@{loop.\+h}}
\subsubsection[{co\+\_\+loop\+\_\+get\+\_\+timer}]{\setlength{\rightskip}{0pt plus 5cm}{\bf co\+\_\+obj\+\_\+t}$\ast$ co\+\_\+loop\+\_\+get\+\_\+timer (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{ptr, }
\item[{{\bf co\+\_\+obj\+\_\+t} $\ast$}]{context}
\end{DoxyParamCaption}
)}}\label{loop_8h_aac6c95a37b381c1584dbd0e8776c69a3}


gets a socket that is registered with the event loop 


\begin{DoxyParams}{Parameters}
{\em ptr} & void pointer to match against the available timers \\
\hline
{\em context} & a \hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} context pointer (currently unused) \\
\hline
\end{DoxyParams}


References co\+\_\+list\+\_\+parse().



Referenced by \+\_\+unschedule().


\begin{DoxyCode}
448                                                           \{
449   \hyperlink{structco__obj__t}{co\_obj\_t} *timer = NULL;
450   CHECK((timer = \hyperlink{list_8c_a53067bb4fab9f78bdc6e69381bbccd16}{co\_list\_parse}(timers, \_co\_loop\_match\_timer\_i, ptr)), \textcolor{stringliteral}{"Failed to find timer:
       %p"},ptr);
451   \textcolor{keywordflow}{return} timer;
452 error:
453   \textcolor{keywordflow}{return} NULL;
454 \}
\end{DoxyCode}
\hypertarget{loop_8h_aeeb0953602d805cd06c9652dabb851b9}{\index{loop.\+h@{loop.\+h}!co\+\_\+loop\+\_\+remove\+\_\+process@{co\+\_\+loop\+\_\+remove\+\_\+process}}
\index{co\+\_\+loop\+\_\+remove\+\_\+process@{co\+\_\+loop\+\_\+remove\+\_\+process}!loop.\+h@{loop.\+h}}
\subsubsection[{co\+\_\+loop\+\_\+remove\+\_\+process}]{\setlength{\rightskip}{0pt plus 5cm}int co\+\_\+loop\+\_\+remove\+\_\+process (
\begin{DoxyParamCaption}
\item[{pid\+\_\+t}]{pid}
\end{DoxyParamCaption}
)}}\label{loop_8h_aeeb0953602d805cd06c9652dabb851b9}


removes a process from the event loop 


\begin{DoxyParams}{Parameters}
{\em pid} & the id of the process to be removed \\
\hline
\end{DoxyParams}


References co\+\_\+list\+\_\+delete(), and co\+\_\+list\+\_\+parse().


\begin{DoxyCode}
319                                       \{
320   \hyperlink{structco__obj__t}{co\_obj\_t} *proc = NULL;
321   CHECK((proc = \hyperlink{list_8c_a53067bb4fab9f78bdc6e69381bbccd16}{co\_list\_parse}(processes, \_co\_loop\_match\_process\_i, &pid)), \textcolor{stringliteral}{"Failed to delete
       process %d!"}, pid);
322   proc = \hyperlink{list_8c_a80fbd77f231ae88663c5d0bb25bdfd6c}{co\_list\_delete}(processes, proc);
323   ((\hyperlink{structco__process__t}{co\_process\_t}*)proc)->registered = \textcolor{keyword}{false}; 
324   \textcolor{keywordflow}{return} 1;
325 
326 error:
327   \textcolor{keywordflow}{return} 0;
328 \}
\end{DoxyCode}
\hypertarget{loop_8h_a73e03ee56a79f6b03a33d4edfa14f646}{\index{loop.\+h@{loop.\+h}!co\+\_\+loop\+\_\+remove\+\_\+socket@{co\+\_\+loop\+\_\+remove\+\_\+socket}}
\index{co\+\_\+loop\+\_\+remove\+\_\+socket@{co\+\_\+loop\+\_\+remove\+\_\+socket}!loop.\+h@{loop.\+h}}
\subsubsection[{co\+\_\+loop\+\_\+remove\+\_\+socket}]{\setlength{\rightskip}{0pt plus 5cm}int co\+\_\+loop\+\_\+remove\+\_\+socket (
\begin{DoxyParamCaption}
\item[{{\bf co\+\_\+obj\+\_\+t} $\ast$}]{old\+\_\+sock, }
\item[{{\bf co\+\_\+obj\+\_\+t} $\ast$}]{context}
\end{DoxyParamCaption}
)}}\label{loop_8h_a73e03ee56a79f6b03a33d4edfa14f646}


removes a socket from the event loop 


\begin{DoxyParams}{Parameters}
{\em old\+\_\+sock} & the socket to be removed \\
\hline
{\em context} & a \hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} context pointer (currently unused) \\
\hline
\end{DoxyParams}


References co\+\_\+list\+\_\+delete(), and co\+\_\+list\+\_\+parse().



Referenced by co\+\_\+loop\+\_\+add\+\_\+socket().


\begin{DoxyCode}
375                                                                  \{
376   \hyperlink{structco__socket__t}{co\_socket\_t} *sock = (\hyperlink{structco__socket__t}{co\_socket\_t}*)old\_sock;
377   \hyperlink{structco__obj__t}{co\_obj\_t} *node = NULL;
378   CHECK((node = \hyperlink{list_8c_a53067bb4fab9f78bdc6e69381bbccd16}{co\_list\_parse}(sockets, \_co\_loop\_match\_socket\_i, sock->uri)), \textcolor{stringliteral}{"Failed to delete
       socket %s!"}, sock->uri);
379   \hyperlink{list_8c_a80fbd77f231ae88663c5d0bb25bdfd6c}{co\_list\_delete}(sockets, node);
380   sock->fd\_registered = \textcolor{keyword}{false}; 
381   epoll\_ctl(poll\_fd, EPOLL\_CTL\_DEL, sock->fd->fd, NULL);
382   CHECK(\hyperlink{list_8c_a53067bb4fab9f78bdc6e69381bbccd16}{co\_list\_parse}(sock->rfd\_lst,\_co\_loop\_remove\_fd\_i,NULL) == NULL,\textcolor{stringliteral}{"Failed to delete
       rfd\_lst"});
383   \textcolor{keywordflow}{return} 1;
384 
385 error:
386   \textcolor{keywordflow}{return} 0;
387 \}
\end{DoxyCode}
\hypertarget{loop_8h_a15cca15cee610bb8222250aef0073b8e}{\index{loop.\+h@{loop.\+h}!co\+\_\+loop\+\_\+remove\+\_\+timer@{co\+\_\+loop\+\_\+remove\+\_\+timer}}
\index{co\+\_\+loop\+\_\+remove\+\_\+timer@{co\+\_\+loop\+\_\+remove\+\_\+timer}!loop.\+h@{loop.\+h}}
\subsubsection[{co\+\_\+loop\+\_\+remove\+\_\+timer}]{\setlength{\rightskip}{0pt plus 5cm}int co\+\_\+loop\+\_\+remove\+\_\+timer (
\begin{DoxyParamCaption}
\item[{{\bf co\+\_\+obj\+\_\+t} $\ast$}]{old\+\_\+timer, }
\item[{{\bf co\+\_\+obj\+\_\+t} $\ast$}]{context}
\end{DoxyParamCaption}
)}}\label{loop_8h_a15cca15cee610bb8222250aef0073b8e}


removes a timer from the event loop 


\begin{DoxyParams}{Parameters}
{\em old\+\_\+timer} & the timer to remove from list \\
\hline
{\em context} & a \hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} context pointer (currently unused) \\
\hline
\end{DoxyParams}


References co\+\_\+list\+\_\+delete(), and co\+\_\+list\+\_\+parse().



Referenced by \+\_\+unschedule(), and co\+\_\+loop\+\_\+set\+\_\+timer().


\begin{DoxyCode}
429                                                                  \{
430   \hyperlink{structco__timer__t}{co\_timer\_t} *timer = (\hyperlink{structco__timer__t}{co\_timer\_t}*)old\_timer;
431   \hyperlink{structco__obj__t}{co\_obj\_t} *node = NULL;
432   
433   \textcolor{keywordflow}{if} (!timer->pending)
434     \textcolor{keywordflow}{return} 0;
435   
436   \textcolor{comment}{// remove from list}
437   CHECK((node = \hyperlink{list_8c_a53067bb4fab9f78bdc6e69381bbccd16}{co\_list\_parse}(timers, \_co\_loop\_match\_timer\_i, timer->ptr)),
438   \textcolor{stringliteral}{"Failed to delete timer %ld.%06ld %p"},timer->deadline.tv\_sec,timer->deadline.tv\_usec,timer->ptr);
439   \hyperlink{list_8c_a80fbd77f231ae88663c5d0bb25bdfd6c}{co\_list\_delete}(timers,node);
440   
441   timer->pending = \textcolor{keyword}{false};
442   \textcolor{keywordflow}{return} 1;
443 
444 error:
445   \textcolor{keywordflow}{return} 0;
446 \}
\end{DoxyCode}
\hypertarget{loop_8h_a47313da5ab494c447679836e95b01a26}{\index{loop.\+h@{loop.\+h}!co\+\_\+loop\+\_\+set\+\_\+timer@{co\+\_\+loop\+\_\+set\+\_\+timer}}
\index{co\+\_\+loop\+\_\+set\+\_\+timer@{co\+\_\+loop\+\_\+set\+\_\+timer}!loop.\+h@{loop.\+h}}
\subsubsection[{co\+\_\+loop\+\_\+set\+\_\+timer}]{\setlength{\rightskip}{0pt plus 5cm}int co\+\_\+loop\+\_\+set\+\_\+timer (
\begin{DoxyParamCaption}
\item[{{\bf co\+\_\+obj\+\_\+t} $\ast$}]{timer, }
\item[{long}]{msecs, }
\item[{{\bf co\+\_\+obj\+\_\+t} $\ast$}]{context}
\end{DoxyParamCaption}
)}}\label{loop_8h_a47313da5ab494c447679836e95b01a26}


sets timer to expire in msecs from now 


\begin{DoxyParams}{Parameters}
{\em timer} & the timer to set \\
\hline
{\em msecs} & number of milliseconds \\
\hline
{\em context} & a \hyperlink{structco__obj__t}{co\+\_\+obj\+\_\+t} context pointer (currently unused) \\
\hline
\end{DoxyParams}


References co\+\_\+loop\+\_\+add\+\_\+timer(), and co\+\_\+loop\+\_\+remove\+\_\+timer().


\begin{DoxyCode}
456                                                                           \{
457   \hyperlink{structco__timer__t}{co\_timer\_t} *timer = (\hyperlink{structco__timer__t}{co\_timer\_t}*)old\_timer;
458   \textcolor{keyword}{struct }timeval *deadline = &timer->deadline;
459   
460   \textcolor{keywordflow}{if} (timer->pending)
461     \hyperlink{loop_8c_a15cca15cee610bb8222250aef0073b8e}{co\_loop\_remove\_timer}((\hyperlink{structco__obj__t}{co\_obj\_t}*)timer,context);
462   
463   \_co\_loop\_gettime(&timer->deadline);
464   
465   deadline->tv\_sec += msecs / 1000;
466   deadline->tv\_usec += (msecs % 1000) * 1000;
467   
468   \textcolor{keywordflow}{if} (deadline->tv\_usec > 1000000) \{
469     deadline->tv\_sec++;
470     deadline->tv\_usec %= 1000000;
471   \}
472   
473   \textcolor{keywordflow}{return} \hyperlink{loop_8c_a1aa3e1a56c2c4d841f4a5a481a5cbd57}{co\_loop\_add\_timer}((\hyperlink{structco__obj__t}{co\_obj\_t}*)timer,context);
474 \}
\end{DoxyCode}
\hypertarget{loop_8h_ad2df16784f2796d2415250cd0a2abd19}{\index{loop.\+h@{loop.\+h}!co\+\_\+timer\+\_\+create@{co\+\_\+timer\+\_\+create}}
\index{co\+\_\+timer\+\_\+create@{co\+\_\+timer\+\_\+create}!loop.\+h@{loop.\+h}}
\subsubsection[{co\+\_\+timer\+\_\+create}]{\setlength{\rightskip}{0pt plus 5cm}{\bf co\+\_\+obj\+\_\+t}$\ast$ co\+\_\+timer\+\_\+create (
\begin{DoxyParamCaption}
\item[{struct timeval}]{deadline, }
\item[{co\+\_\+cb\+\_\+t}]{timer\+\_\+cb, }
\item[{void $\ast$}]{ptr}
\end{DoxyParamCaption}
)}}\label{loop_8h_ad2df16784f2796d2415250cd0a2abd19}


malloc and initialize a timer 


\begin{DoxyParams}{Parameters}
{\em size} & timer struct size \\
\hline
{\em proto} & timer protocol \\
\hline
\end{DoxyParams}


Referenced by \+\_\+schedule().


\begin{DoxyCode}
476                                                                                 \{
477   \hyperlink{structco__timer__t}{co\_timer\_t} *new\_timer = h\_calloc(1,\textcolor{keyword}{sizeof}(\hyperlink{structco__timer__t}{co\_timer\_t}));
478   
479   new\_timer->\_header.\_type = \_ext8;
480   new\_timer->\_header.\_ref = 0;
481   new\_timer->\_header.\_flags = 0;
482   new\_timer->\_exttype = \_co\_timer;
483   new\_timer->\_len = \textcolor{keyword}{sizeof}(\hyperlink{structco__timer__t}{co\_timer\_t});
484   new\_timer->pending = \textcolor{keyword}{false};
485   \textcolor{keywordflow}{if} (deadline.tv\_sec > 0 || deadline.tv\_usec > 0) \{
486     new\_timer->deadline.tv\_sec = deadline.tv\_sec;
487     new\_timer->deadline.tv\_usec = deadline.tv\_usec;
488   \} \textcolor{keywordflow}{else}
489     new\_timer->deadline = (\textcolor{keyword}{struct }timeval)\{0\};
490   new\_timer->timer\_cb = timer\_cb ? timer\_cb : NULL;
491   new\_timer->ptr = ptr ? ptr : (\textcolor{keywordtype}{void}*)new\_timer;
492   
493   \textcolor{keywordflow}{return} (\hyperlink{structco__obj__t}{co\_obj\_t}*)new\_timer;
494 \}
\end{DoxyCode}
