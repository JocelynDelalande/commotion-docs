\hypertarget{daemon_8c}{\section{src/daemon.c File Reference}
\label{daemon_8c}\index{src/daemon.\-c@{src/daemon.\-c}}
}


commotiond -\/ an embedded C daemon for managing mesh networks.  


{\ttfamily \#include $<$stdlib.\-h$>$}\\*
{\ttfamily \#include $<$stdio.\-h$>$}\\*
{\ttfamily \#include $<$getopt.\-h$>$}\\*
{\ttfamily \#include $<$unistd.\-h$>$}\\*
{\ttfamily \#include $<$signal.\-h$>$}\\*
{\ttfamily \#include $<$fcntl.\-h$>$}\\*
{\ttfamily \#include $<$sys/socket.\-h$>$}\\*
{\ttfamily \#include $<$sys/types.\-h$>$}\\*
{\ttfamily \#include $<$sys/stat.\-h$>$}\\*
{\ttfamily \#include $<$arpa/inet.\-h$>$}\\*
{\ttfamily \#include $<$limits.\-h$>$}\\*
{\ttfamily \#include \char`\"{}config.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}debug.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}cmd.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}util.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}loop.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}plugin.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}process.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}profile.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}socket.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}msg.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}iface.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}id.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}obj.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}list.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}tree.\-h\char`\"{}}\\*
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\hypertarget{daemon_8c_aed167a6fd20a96a7d72a87558e1798f2}{\#define {\bfseries R\-E\-Q\-U\-E\-S\-T\-\_\-\-M\-A\-X}~1024}\label{daemon_8c_aed167a6fd20a96a7d72a87558e1798f2}

\item 
\hypertarget{daemon_8c_ac14c6b4a2d0888268744a6496ee33183}{\#define {\bfseries R\-E\-S\-P\-O\-N\-S\-E\-\_\-\-M\-A\-X}~1024}\label{daemon_8c_ac14c6b4a2d0888268744a6496ee33183}

\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hypertarget{daemon_8c_a940b48b3bfcda0769ea52c6c1e797e4b}{{\bfseries S\-C\-H\-E\-M\-A} (default)}\label{daemon_8c_a940b48b3bfcda0769ea52c6c1e797e4b}

\item 
\hypertarget{daemon_8c_a5cf1b7f8fddaa1bc3e9a88eec93a7649}{{\bfseries S\-C\-H\-E\-M\-A} (global)}\label{daemon_8c_a5cf1b7f8fddaa1bc3e9a88eec93a7649}

\item 
\hypertarget{daemon_8c_a96a24001c137324549512cf28d8f4084}{{\bfseries C\-M\-D} (help)}\label{daemon_8c_a96a24001c137324549512cf28d8f4084}

\item 
\hypertarget{daemon_8c_abccaf4abcdcdb5b2fb84969205c50618}{{\bfseries C\-M\-D} (profiles)}\label{daemon_8c_abccaf4abcdcdb5b2fb84969205c50618}

\item 
\hypertarget{daemon_8c_afbc27086e79e6b66573bdfb678d3992c}{{\bfseries C\-M\-D} (up)}\label{daemon_8c_afbc27086e79e6b66573bdfb678d3992c}

\item 
\hypertarget{daemon_8c_a917c82ba53e7543b36ef0d2a21b369ca}{{\bfseries C\-M\-D} (down)}\label{daemon_8c_a917c82ba53e7543b36ef0d2a21b369ca}

\item 
\hypertarget{daemon_8c_a8157d50ea6c088206d0d9c729891de70}{{\bfseries C\-M\-D} (status)}\label{daemon_8c_a8157d50ea6c088206d0d9c729891de70}

\item 
\hypertarget{daemon_8c_a43a58c28fd804f8beb8b6ff2fd85e2a4}{{\bfseries C\-M\-D} (state)}\label{daemon_8c_a43a58c28fd804f8beb8b6ff2fd85e2a4}

\item 
\hypertarget{daemon_8c_af03b020e3e677f7b2e1ef15d3eb38bb5}{{\bfseries C\-M\-D} (nodeid)}\label{daemon_8c_af03b020e3e677f7b2e1ef15d3eb38bb5}

\item 
\hypertarget{daemon_8c_a07f8f805ac4fdfbb9d3c21832da28cde}{{\bfseries C\-M\-D} (genip)}\label{daemon_8c_a07f8f805ac4fdfbb9d3c21832da28cde}

\item 
\hypertarget{daemon_8c_ae240b8e752c1d73259a3bec7f7f5ac98}{{\bfseries C\-M\-D} (genbssid)}\label{daemon_8c_ae240b8e752c1d73259a3bec7f7f5ac98}

\item 
\hypertarget{daemon_8c_ab9318c76808478b3acd98eee8e986b55}{{\bfseries C\-M\-D} (set)}\label{daemon_8c_ab9318c76808478b3acd98eee8e986b55}

\item 
\hypertarget{daemon_8c_afed19a0e2fba907b0ec248713840e196}{{\bfseries C\-M\-D} (get)}\label{daemon_8c_afed19a0e2fba907b0ec248713840e196}

\item 
\hypertarget{daemon_8c_aa4e5d414e43a00f66cc96d71544ecc45}{{\bfseries C\-M\-D} (save)}\label{daemon_8c_aa4e5d414e43a00f66cc96d71544ecc45}

\item 
\hypertarget{daemon_8c_a0418f34318e13b2e7df46db6716eb117}{{\bfseries C\-M\-D} (new)}\label{daemon_8c_a0418f34318e13b2e7df46db6716eb117}

\item 
\hypertarget{daemon_8c_a1dd760510e5542d470830dded0f65c1d}{{\bfseries C\-M\-D} (delete)}\label{daemon_8c_a1dd760510e5542d470830dded0f65c1d}

\item 
int \hyperlink{daemon_8c_af68a09cb7d1ba46ac46187c590dc6468}{dispatcher\-\_\-cb} (\hyperlink{structco__obj__t}{co\-\_\-obj\-\_\-t} $\ast$self, \hyperlink{structco__obj__t}{co\-\_\-obj\-\_\-t} $\ast$fd)
\begin{DoxyCompactList}\small\item\em sends/receives socket messages \end{DoxyCompactList}\item 
\hypertarget{daemon_8c_a0ddf1224851353fc92bfbff6f499fa97}{int \hyperlink{daemon_8c_a0ddf1224851353fc92bfbff6f499fa97}{main} (int argc, char $\ast$argv\mbox{[}$\,$\mbox{]})}\label{daemon_8c_a0ddf1224851353fc92bfbff6f499fa97}

\begin{DoxyCompactList}\small\item\em Creates sockets for event loop, daemon and dispatcher. Starts/stops event loop. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hypertarget{daemon_8c_aa65a52def72a691a94bbe3b7e993c1b8}{\hyperlink{structco__socket__t}{co\-\_\-socket\-\_\-t} {\bfseries unix\-\_\-socket\-\_\-proto}}\label{daemon_8c_aa65a52def72a691a94bbe3b7e993c1b8}

\end{DoxyCompactItemize}


\subsection{Detailed Description}
commotiond -\/ an embedded C daemon for managing mesh networks. \begin{DoxyAuthor}{Author}
Josh King (jheretic), \href{mailto:jking@chambana.net}{\tt jking@chambana.\-net} 
\end{DoxyAuthor}


\subsection{Function Documentation}
\hypertarget{daemon_8c_af68a09cb7d1ba46ac46187c590dc6468}{\index{daemon.\-c@{daemon.\-c}!dispatcher\-\_\-cb@{dispatcher\-\_\-cb}}
\index{dispatcher\-\_\-cb@{dispatcher\-\_\-cb}!daemon.c@{daemon.\-c}}
\subsubsection[{dispatcher\-\_\-cb}]{\setlength{\rightskip}{0pt plus 5cm}int dispatcher\-\_\-cb (
\begin{DoxyParamCaption}
\item[{{\bf co\-\_\-obj\-\_\-t} $\ast$}]{self, }
\item[{{\bf co\-\_\-obj\-\_\-t} $\ast$}]{fd}
\end{DoxyParamCaption}
)}}\label{daemon_8c_af68a09cb7d1ba46ac46187c590dc6468}


sends/receives socket messages 


\begin{DoxyParams}{Parameters}
{\em self} & pointer to dispatcher socket struct \\
\hline
{\em fd} & file descriptor object of connected socket \\
\hline
\end{DoxyParams}


References co\-\_\-cmd\-\_\-exec(), co\-\_\-list\-\_\-element(), co\-\_\-list\-\_\-import(), co\-\_\-response\-\_\-alloc(), and co\-\_\-tree\-\_\-insert().



Referenced by main().


\begin{DoxyCode}
707                                                 \{
708   CHECK(IS\_SOCK(\textcolor{keyword}{self}),\textcolor{stringliteral}{"Not a socket."});
709   \hyperlink{structco__socket__t}{co\_socket\_t} *sock = (\hyperlink{structco__socket__t}{co\_socket\_t}*)\textcolor{keyword}{self};
710   \textcolor{keywordtype}{char} reqbuf[REQUEST\_MAX];
711   memset(reqbuf, \textcolor{charliteral}{'\(\backslash\)0'}, \textcolor{keyword}{sizeof}(reqbuf));
712   ssize\_t reqlen = 0;
713   \textcolor{keywordtype}{char} respbuf[RESPONSE\_MAX];
714   memset(respbuf, \textcolor{charliteral}{'\(\backslash\)0'}, \textcolor{keyword}{sizeof}(respbuf));
715   \textcolor{keywordtype}{size\_t} resplen = 0;
716   \hyperlink{structco__obj__t}{co\_obj\_t} *request = NULL;
717   uint8\_t *type = NULL;
718   uint32\_t *\textcolor{keywordtype}{id} = NULL;
719   \hyperlink{structco__obj__t}{co\_obj\_t} *nil = co\_nil\_create(0);
720 
721   \textcolor{comment}{/* Incoming message on socket */}
722   reqlen = sock->receive((\hyperlink{structco__obj__t}{co\_obj\_t}*)sock, fd, reqbuf, \textcolor{keyword}{sizeof}(reqbuf));
723   DEBUG(\textcolor{stringliteral}{"Received %d bytes."}, (\textcolor{keywordtype}{int})reqlen);
724   \textcolor{keywordflow}{if}(reqlen == 0) \{
725     INFO(\textcolor{stringliteral}{"Received connection."});
726     \textcolor{keywordflow}{return} 1;
727   \}
728   \textcolor{keywordflow}{if} (reqlen < 0) \{
729     INFO(\textcolor{stringliteral}{"Connection recvd() -1"});
730     sock->hangup((\hyperlink{structco__obj__t}{co\_obj\_t}*)sock, fd);
731     \textcolor{keywordflow}{return} 1;
732   \}
733   \textcolor{comment}{/* If it's a commotion message type, parse the header, target and payload */}
734   CHECK(\hyperlink{list_8c_a07c935572c069373bddadf2907a09b2b}{co\_list\_import}(&request, reqbuf, reqlen) > 0, \textcolor{stringliteral}{"Failed to import request."});
735   co\_obj\_data((\textcolor{keywordtype}{char} **)&type, \hyperlink{list_8c_a647ff4c713547b65d3fa7a1a7cc7dff7}{co\_list\_element}(request, 0)); 
736   CHECK(*type == 0, \textcolor{stringliteral}{"Not a valid request."});
737   CHECK(co\_obj\_data((\textcolor{keywordtype}{char} **)&\textcolor{keywordtype}{id}, \hyperlink{list_8c_a647ff4c713547b65d3fa7a1a7cc7dff7}{co\_list\_element}(request, 1)) == \textcolor{keyword}{sizeof}(uint32\_t), \textcolor{stringliteral}{"Not a
       valid request ID."});
738   \hyperlink{structco__obj__t}{co\_obj\_t} *ret = NULL;
739   \textcolor{keywordflow}{if}(\hyperlink{cmd_8h_a3e3db670f8a4187b7e198804c2e8dd6a}{co\_cmd\_exec}(\hyperlink{list_8c_a647ff4c713547b65d3fa7a1a7cc7dff7}{co\_list\_element}(request, 2), &ret, 
      \hyperlink{list_8c_a647ff4c713547b65d3fa7a1a7cc7dff7}{co\_list\_element}(request, 3)))
740   \{
741     resplen = \hyperlink{msg_8c_aee952060c704142198bfa0de4c5d8c93}{co\_response\_alloc}(respbuf, \textcolor{keyword}{sizeof}(respbuf), *\textcolor{keywordtype}{id}, nil, ret);
742     sock->send(fd, respbuf, resplen);
743   \}
744   \textcolor{keywordflow}{else}
745   \{
746     \textcolor{keywordflow}{if}(ret == NULL)
747     \{
748       ret = co\_tree16\_create();
749       \hyperlink{tree_8c_a1693a84a751373827f76a7383322e105}{co\_tree\_insert}(ret, \textcolor{stringliteral}{"error"}, \textcolor{keyword}{sizeof}(\textcolor{stringliteral}{"error"}), co\_str8\_create(\textcolor{stringliteral}{"Incorrect command."}, \textcolor{keyword}{
      sizeof}(\textcolor{stringliteral}{"Incorrect command."}), 0));
750     \}
751     resplen = \hyperlink{msg_8c_aee952060c704142198bfa0de4c5d8c93}{co\_response\_alloc}(respbuf, \textcolor{keyword}{sizeof}(respbuf), *\textcolor{keywordtype}{id}, ret, nil);
752     sock->send(fd, respbuf, resplen);
753   \}
754 
755   co\_obj\_free(nil);
756   co\_obj\_free(request);
757   co\_obj\_free(ret);
758   \textcolor{keywordflow}{return} 1;
759 error:
760   co\_obj\_free(nil);
761   co\_obj\_free(request);
762   co\_obj\_free(ret);
763   \textcolor{keywordflow}{return} 1;
764 \}
\end{DoxyCode}
